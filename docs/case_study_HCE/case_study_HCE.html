<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Case Study in Human Contexts and Ethics – Data 100: Principles and Techniques of Data Science</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../assets/images/data100_logo.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-42ed7287b56c5c583e2c2463c9cf4916.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar docked quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../case_study_HCE/case_study_HCE.html">Case Study in Human Contexts and Ethics</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../assets/images/data100_logo.png" alt="Data 100 logo" class="sidebar-logo light-content py-0 d-lg-inline d-none">
      <img src="../assets/images/data100_logo.png" alt="Data 100 logo" class="sidebar-logo dark-content py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Data 100 Course Notes</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/DS-100/course-notes" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../intro_lec/introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../pandas_1/pandas_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pandas I</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../pandas_2/pandas_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pandas II</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../pandas_3/pandas_3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pandas III</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../eda/eda.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Cleaning and EDA</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../regex/regex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Regular Expressions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../visualization_1/visualization_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualization I</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../visualization_2/visualization_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualization II</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../sampling/sampling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sampling</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../modeling_slr/modeling_slr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Modeling &amp; SLR</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../constant_model_loss_transformations/loss_transformations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Constant Model, Loss, and Transformations</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../ols/ols.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ordinary Least Squares</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../case_study_HCE/case_study_HCE.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Case Study in Human Contexts and Ethics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../gradient_descent/gradient_descent.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">sklearn and Gradient Descent</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../feature_engineering/feature_engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Gradient Descent Continuation, Feature Engineering</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../cv_regularization/cv_reg.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Cross Validation and Regularization</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../probability_1/probability_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Random Variables</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../probability_2/probability_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Estimators, Bias, and Variance</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../inference_causality/inference_causality.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Parameter Inference and Bootstrapping</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../sql_I/sql_I.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SQL I</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../sql_II/sql_II.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SQL II</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../logistic_regression_1/logistic_reg_1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Logistic Regression I</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../logistic_regression_2/logistic_reg_2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Logistic Regression II</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../clustering/clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Clustering</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../pca/pca.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">PCA</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-problem" id="toc-the-problem" class="nav-link active" data-scroll-target="#the-problem">The Problem</a>
  <ul>
  <li><a href="#spotlight-appeals" id="toc-spotlight-appeals" class="nav-link" data-scroll-target="#spotlight-appeals">Spotlight: Appeals</a></li>
  <li><a href="#human-impacts" id="toc-human-impacts" class="nav-link" data-scroll-target="#human-impacts">Human Impacts</a></li>
  </ul></li>
  <li><a href="#the-response-cook-county-open-data-initiative" id="toc-the-response-cook-county-open-data-initiative" class="nav-link" data-scroll-target="#the-response-cook-county-open-data-initiative">The Response: Cook County Open Data Initiative</a>
  <ul>
  <li><a href="#questionproblem-formulation" id="toc-questionproblem-formulation" class="nav-link" data-scroll-target="#questionproblem-formulation">1. Question/Problem Formulation</a></li>
  <li><a href="#data-acquisition-and-cleaning" id="toc-data-acquisition-and-cleaning" class="nav-link" data-scroll-target="#data-acquisition-and-cleaning">2. Data Acquisition and Cleaning</a></li>
  <li><a href="#exploratory-data-analysis" id="toc-exploratory-data-analysis" class="nav-link" data-scroll-target="#exploratory-data-analysis">3. Exploratory Data Analysis</a></li>
  <li><a href="#prediction-and-inference" id="toc-prediction-and-inference" class="nav-link" data-scroll-target="#prediction-and-inference">4. Prediction and Inference</a></li>
  <li><a href="#results-and-conclusions" id="toc-results-and-conclusions" class="nav-link" data-scroll-target="#results-and-conclusions">5. Results and Conclusions</a></li>
  </ul></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways">Key Takeaways</a></li>
  <li><a href="#lessons-for-data-science-practice-questions-to-consider" id="toc-lessons-for-data-science-practice-questions-to-consider" class="nav-link" data-scroll-target="#lessons-for-data-science-practice-questions-to-consider">Lessons for Data Science Practice: Questions to Consider</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Case Study in Human Contexts and Ethics</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><strong>Note:</strong> Given the nuanced nature of some of the arguments made in the lecture, it is highly recommended that you view the lecture recording given by Professor Ari Edmundson to fully engage and understand the material. The course notes will have the same broader structure but are by no means comprehensive.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Learning Outcomes
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<ul>
<li>Learn about the ethical dilemmas that data scientists face.</li>
<li>Examine the Cook County Assessor’s Office and Property Appraisal case study for fairness in housing appraisal.</li>
<li>Know how to critique models using contextual knowledge about data.</li>
</ul>
</div>
</div>
</div>
<blockquote class="blockquote">
<p><strong>Disclaimer</strong>: The following note discusses issues of structural racism. Some of the items in this note may be sensitive and may or may not be the opinions, ideas, and beliefs of the students who collected the materials. The Data 100 course staff tries its best to only present information that is relevant for teaching the lessons at hand.</p>
</blockquote>
<p>As data scientists, our goal is to wrangle data, recognize patterns and use them to make predictions within a certain context. However, it is often easy to abstract data away from its original context. In previous lectures, we’ve explored datasets like <code>elections</code>, <code>babynames</code>, and <code>world_bank</code> to learn fundamental techniques for working with data, but rarely do we stop to ask questions like “How/when was this data collected?” or “Are there any inherent biases in the data that could affect results?”. It turns out that inquiries like these profoundly affect how data scientists approach a task and convey their findings. This lecture explores these ethical dilemmas through the lens of a case study.</p>
<p>Let’s immerse ourselves in the real-world story of data scientists working for an organization called the Cook County Assessor’s Office (CCAO) located in Chicago, Illinois. Their job is to <strong>estimate the values of houses</strong> in order to <strong>assign property taxes</strong>. This is because the tax burden in this area is determined by the estimated <strong>value</strong> of a house rather than its price. Since value changes over time and has no obvious indicators, the CCAO created a <strong>model</strong> to estimate the values of houses. In this note, we will dig deep into biases that arose in the model, the consequences to human lives, and what we can learn from this example to avoid the same mistakes in the future.</p>
<section id="the-problem" class="level2">
<h2 class="anchored" data-anchor-id="the-problem">The Problem</h2>
<p>What prompted the formation of the CCAO and led to the development of this model? In 2017, an <a href="https://apps.chicagotribune.com/news/watchdog/cook-county-property-tax-divide/assessments.html">investigative report</a> by the <em>Chicago Tribune</em> uncovered a major scandal in the property assessment system managed by the CCAO under the watch of former County Assessor Joseph Berrios. Working with experts from the University of Chicago, the <em>Chicago Tribune</em> journalists found that the CCAO’s model for estimating house value perpetuated a highly regressive tax system that disproportionately burdened African-American and Latinx homeowners in Cook County. How did the journalists demonstrate this disparity?</p>
<center>
<a href="https://apps.chicagotribune.com/news/watchdog/cook-county-property-tax-divide/assessments.html"> <img src="images/vis_1.png" alt="On the left is the coefficient of dispersion and on the right is the price related differential."></a>
</center>
<p>The image above shows two standard metrics to estimate the fairness of assessments: the <a href="https://www.realestateagent.com/real-estate-glossary/real-estate/coefficient-of-dispersion.html">coefficient of dispersion</a> and <a href="https://leg.wa.gov/House/Committees/FIN/Documents/2009/RatioText.pdf">price-related differential</a>. How they’re calculated is out of scope for this class, but you can assume that these metrics have been rigorously tested by experts in the field and are a good indication of fairness. As we see above, calculating these metrics for the Cook County prices revealed that the pricing created by the CCAO did not fall in acceptable ranges. While this on its own is <strong>not the entire</strong> story, it was a good indicator that <strong>something fishy was going on</strong>.</p>
<center>
<a href="https://apps.chicagotribune.com/news/watchdog/cook-county-property-tax-divide/assessments.html"> <img src="images/vis_2.png" width="300" alt="As income level rises, effective tax rates decline."></a>
</center>
<p>This prompted journalists to investigate if the CCAO’s model itself was producing fair tax rates. When accounting for the homeowner’s income, they found that the model actually produced a <strong>regressive</strong> tax rate (see figure above). A tax rate is <strong>regressive</strong> if the percentage tax rate is higher for individuals with lower net income; it is <strong>progressive</strong> if the percentage tax rate is higher for individuals with higher net income. The figure below shows a simple representation of progressive and regressive tax rate.</p>
<center>
<img src="images/regressive_tax.png" width="300" alt="Income is on the x-axis. Tax rate is on the y-axis. A horizontal line in the center of the y-axis is labeled 'proportional.' A line where both income and tax rate increases is labeled progressive. Another line where both income and tax rate decreases is labeled regressive.">
</center>
<p>Digging further, journalists found that the model was not only regressive and unfair to lower-income individuals, but it was also unfair to non-white homeowners (see figure below).</p>
<center>
<a href="https://www.clccrul.org/bpnc-v-berrios-facts?rq=berrios"> <img src="images/vis_3.jpg" width="600" alt="Line plot titled 'Average Percent Over/Under Assessment by Percent White, 2011-2015.' On average, as the percent white in the census tract increases, the average percent over/under assessed decreases"> </a>
</center>
<p><br></p>
<p>The likelihood of a property being under- or over-assessed was highly dependent on the owner’s race, and that did not sit well with many homeowners.</p>
<section id="spotlight-appeals" class="level3">
<h3 class="anchored" data-anchor-id="spotlight-appeals">Spotlight: Appeals</h3>
<p>What was the cause of such a major issue? It might be easy to simply blame “biased” algorithms, but the main issue was not a faulty model. Instead, it was largely due to the <strong>appeals system</strong> which enabled the wealthy and privileged to more easily and successfully challenge their assessments. Once given the CCAO model’s initial assessment of their home’s value, homeowners could choose to appeal to a board of elected officials to try and change the listed value of their home and, consequently, how much they are taxed. In theory, this sounds like a very fair system: a human being oversees the final pricing of houses rather than a computer algorithm. In reality, this ended up exacerbating the problem.</p>
<blockquote class="blockquote">
<p>“Appeals are a good thing,” Thomas Jaconetty, deputy assessor for valuation and appeals, said in an interview. “The goal here is fairness. We made the numbers. We can change them.”</p>
</blockquote>
<center>
<a href="https://apps.chicagotribune.com/news/watchdog/cook-county-property-tax-divide/appeals.html"> <img src="images/vis_4.png" alt="Neighborhood demographics affect appeals rate."> </a>
</center>
<p><br></p>
<p>We can borrow lessons from <a href="https://www.britannica.com/topic/critical-race-theory">Critical Race Theory</a> —— on the surface, everyone has the legal right to try and appeal the value of their home. However, not everyone has an <em>equal ability</em> to do so. Those who have the money to hire tax lawyers to appeal for them have a drastically higher chance of trying and succeeding in their appeal (see above figure). Many homeowners who appealed were generally under-assessed compared to homeowners who did not (see figure below). Clearly, the model is part of a deeper institutional pattern rife with potential corruption.</p>
<center>
<a href="https://apps.chicagotribune.com/news/watchdog/cook-county-property-tax-divide/appeals.html"> <img src="images/vis_5.png" alt="On the left, we see that the highest percentage of homeowners who appealed was towards the right hand side of the geographic area represented. But on the right, we see that the greatest number of years that homes were overvalues is on the left hand side of the geographic region."> </a>
</center>
<p><br></p>
<p>In fact, Chicago boasts a large and thriving tax attorney industry dedicated precisely to appealing property assessments, reflected in the growing number of appeals in Cook County in the 21st century. Given wealthier, whiter neighborhoods typically have greater access to lawyers, they often appealed more and won reductions far more often than their less wealthy neighbors. In other words, those with higher incomes pay less in property tax, tax lawyers can grow their business due to their role in appeals, and politicians are socially connected to the aforementioned tax lawyers and wealthy homeowners. All these stakeholders have reasons to advertise the appeals system as an integral part of a fair system; after all, it serves to benefit them. Here lies the value in asking questions: a system that seems fair on the surface may, in reality, be unfair upon taking a closer look.</p>
</section>
<section id="human-impacts" class="level3">
<h3 class="anchored" data-anchor-id="human-impacts">Human Impacts</h3>
<center>
<a href="https://apps.chicagotribune.com/news/watchdog/cook-county-property-tax-divide/assessments.html"> <img src="images/vis_6.png" alt="An image of a house captioned: In 2011, Braxton-Williams learned that the assessor's office had valued the house at $147,550. 'I love my house, but I know it's not worth that much,' she said. 'And they know it's not worth that much.'"> </a>
</center>
<p><br></p>
<p>What happened as a result of this corrupt system? As the <em>Chicago Tribune</em> reported, many African American and Latino homeowners purchased homes only to find their houses were later appraised at levels far higher than what they paid. As a result, homeowners were now responsible for paying significantly more in taxes every year than initially budgeted, putting them at risk of not being able to afford their homes and losing them.</p>
<p>The impact of the housing model extends beyond the realm of home ownership and taxation —— the issues of justice go much deeper. This model perpetrated much older patterns of racially discriminatory practices in Chicago and across the United States. Unfortunately, it is no accident that this happened in Chicago, one of the most segregated cities in the United States (<a href="https://fivethirtyeight.com/features/the-most-diverse-cities-are-often-the-most-segregated/">source</a>). These factors are central to informing us, as data scientists, about what is at stake.</p>
</section>
</section>
<section id="the-response-cook-county-open-data-initiative" class="level2">
<h2 class="anchored" data-anchor-id="the-response-cook-county-open-data-initiative">The Response: Cook County Open Data Initiative</h2>
<p>The response to this problem started in politics. A new assessor, Fritz Kaegi, was elected and created a new mandate with two goals:</p>
<ol type="1">
<li>Distributional equity in property taxation, meaning that properties of the same value are treated alike during assessments.</li>
<li>Creating a new Office of Data Science.</li>
</ol>
<p>He wanted to not only create a more accurate algorithmic model but also to design a new system to address the problems with the CCAO.</p>
<center>
<img src="images/vis_9.png" width="300px" alt="Cook County Government Open Data Logo">
</center>
<p><br></p>
<p>Let’s frame this problem through the lens of the data science lifecycle.</p>
<center>
<img src="images/data_life_cycle.PNG" width="300px" alt="Data science lifecycle">
</center>
<section id="questionproblem-formulation" class="level3">
<h3 class="anchored" data-anchor-id="questionproblem-formulation">1. Question/Problem Formulation</h3>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Driving Questions
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>What do we want to know?</li>
<li>What problems are we trying to solve?</li>
<li>What are the hypotheses we want to test?</li>
<li>What are our metrics for success?</li>
</ul>
</div>
</div>
<p>The old system was unfair because it was systemically inaccurate; it made one kind of error for one group, and another kind of error for another. Its goal was to “create a robust pipeline that accurately assesses property values at scale and is fair”, and in turn, they defined fairness as accuracy: “the ability of our pipeline to accurately assess all residential property values, accounting for disparities in geography, information, etc.” Thus, the plan — make the system more fair — was already framed in terms of a task appropriate to a data scientist: make the assessments more accurate (or more precisely, minimize errors in a particular way).</p>
<p>The idea here is that if the model is more accurate it will also (perhaps necessarily) become more fair, which is a big assumption. There are, in a sense, two different problems — make accurate assessments, and make a fair system. Treating these two problems as one makes it a more straightforward issue that can be solved technically (with a good model) but does raise the question of if fairness and accuracy are one and the same.</p>
<p>For now, let’s just talk about the technical part of this — accuracy. For you, the data scientist, this part might feel more comfortable. We can determine some metrics of success and frame a social problem as a data science problem.</p>
<div class="callout callout-style-default callout-tip no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span><b>Definitions</b>: Fairness and Transparency
</div>
</div>
<div class="callout-body-container callout-body">
<p>The definitions, as given by the Cook County Assessor’s Office, are given below: <br></p>
<ul>
<li>Fairness: The ability of our pipeline to accurately assess property values, accounting for disparities in geography, information, etc. <br></li>
<li>Transparency: The ability of the data science department to share and explain pipeline results and decisions to both internal and external stakeholders <br></li>
</ul>
</div>
</div>
<p>The new Office of Data Science started by framing the problem and redefining their goals. They determined that they needed to:</p>
<ol type="1">
<li>Accurately, uniformly, and impartially assess the value of a home and accurately predict the sale price of a home within the next year by:
<ul>
<li>Following international standards (e.g., coefficient of dispersion)</li>
<li>Predicting the value of all homes with as little total error as possible</li>
</ul></li>
<li>Create a robust pipeline that accurately assesses property values at scale and is fair to all people by:
<ul>
<li>Disrupting the circuit of corruption (Board of Review appeals process)</li>
<li>Eliminating regressivity</li>
<li>Engendering trust in the system among all stakeholders</li>
</ul></li>
</ol>
<p>The goals defined above lead us to ask the question: what does it actually mean to accurately assess property values, and what role does “scale” play?</p>
<ol type="1">
<li>What is an assessment of a home’s value?</li>
<li>What makes one assessment more accurate than another?</li>
<li>What makes one batch of assessments more accurate than another batch?</li>
</ol>
<p>Each of the above questions leads to a slew of more questions. Considering just the first question, one answer could be that an assessment is an estimate of the value of a home. This leads to more inquiries: what is the value of a home? What determines it? How do we know? For this class, we take it to be the house’s market value, or how much it would sell for.</p>
<p>Unfortunately, if you are the county assessor, it becomes hard to determine property values with this definition. After all, you can’t make everyone sell their house every year. And as many properties haven’t been sold in decades, every year that passes makes that previous sale less reliable as an indicator.</p>
<p>So how would one generate reliable estimates? You’re probably thinking, well, with data about homes and their sale prices you can probably predict the value of a property reliably. Even if you’re not a data scientist, you might know there are websites like Zillow and RedFin that estimate what properties would sell for and constantly update them. They don’t know the value, but they estimate them. How do you think they do this? Let’s start with the data —— which is the next step in the lifecycle.</p>
</section>
<section id="data-acquisition-and-cleaning" class="level3">
<h3 class="anchored" data-anchor-id="data-acquisition-and-cleaning">2. Data Acquisition and Cleaning</h3>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Driving Questions
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>What data do we have, and what data do we need?</li>
<li>How will we sample more data?</li>
<li>Is our data representative of the population we want to study?</li>
</ul>
</div>
</div>
<p>To generate estimates, the data scientists used two datasets. The first contained all recorded sales data from 2013 to 2019. The second contained property characteristics, including a property identification number and physical characteristics (e.g., age, bedroom, baths, square feet, neighborhood, site desirability, etc.).</p>
<center>
<img src="images/vis_10.png" alt="Overview of the property characteristic dataset with the columns 'feature name,' 'category', and 'type.'">
</center>
<p><br></p>
<p>As they examined the datasets, they asked the questions:</p>
<ol type="1">
<li>How was this data collected?</li>
<li>When was this data collected?</li>
<li>Who collected this data?</li>
<li>For what purposes was the data collected?</li>
<li>How and why were particular categories created?</li>
</ol>
<p>With so much data available, data scientists worked to see how all the different data points correlated with each other and with the sales prices. By discovering patterns in datasets containing known sale prices and characteristics of similar and nearby properties, training a model on this data, and applying it to all the properties without sales data, it was now possible to create a linear model that could predict the sale price (“fair market value”) of unsold properties.</p>
<p>Some other key questions data scientists asked about the data were:</p>
<ol type="1">
<li>Are any attributes of a house differentially reported? How might these attributes be differentially reported?</li>
<li>How are “improvements” like renovations tracked and updated?</li>
<li>Which data is missing, and for which neighborhoods or populations is it missing?</li>
<li>What other data sources or attributes might be valuable?</li>
</ol>
<p>Attributes can have different likelihoods of appearing in the data. For example, housing data in the floodplain geographic region of Chicago were less represented than other regions.</p>
<p>Features can also be reported at different rates. Improvements in homes, which tend to increase property value, were unlikely to be reported by the homeowners.</p>
<p>Additionally, they found that there was simply more missing data in lower-income neighborhoods.</p>
</section>
<section id="exploratory-data-analysis" class="level3">
<h3 class="anchored" data-anchor-id="exploratory-data-analysis">3. Exploratory Data Analysis</h3>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Driving Questions
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>How is our data organized, and what does it contain?</li>
<li>Do we already have relevant data?</li>
<li>What are the biases, anomalies, or other issues with the data?</li>
<li>How do we transform the data to enable effective analysis?</li>
</ul>
</div>
</div>
<p>Before the modeling step, they investigated a multitude of crucial questions:</p>
<ol type="1">
<li>Which attributes are most predictive of sales price?</li>
<li>Is the data uniformly distributed?</li>
<li>Do all neighborhoods have recent data? Do all neighborhoods have the same granularity?<br>
</li>
<li>Do some neighborhoods have missing or outdated data?</li>
</ol>
<p>They found that certain features, such as bedroom number, were much more useful in determining house value for certain neighborhoods than for others. This informed them that different models should be used depending on the neighborhood.</p>
<p>They also noticed that low-income neighborhoods had disproportionately spottier data. This informed them that they needed to develop new data collection practices - including finding new sources of data.</p>
</section>
<section id="prediction-and-inference" class="level3">
<h3 class="anchored" data-anchor-id="prediction-and-inference">4. Prediction and Inference</h3>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Driving Questions
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>What does the data say about the world?</li>
<li>Does it answer our questions or accurately solve the problem?</li>
<li>How robust are our conclusions, and can we trust the predictions?</li>
</ul>
</div>
</div>
<p>Rather than using a singular model to predict sale prices (“fair market value”) of unsold properties, the CCAO predicts sale prices using machine learning models that discover patterns in data sets containing known sale prices and characteristics of <strong>similar and nearby properties</strong>. It uses different model weights for each neighborhood.</p>
<p>Compared to traditional mass appraisal, the CCAO’s new approach is more granular and more sensitive to neighborhood variations.</p>
<p>But how do we know if an assessment is accurate? We can see how our model performs when predicting the sales prices of properties it wasn’t trained on! We can then evaluate how “close” our estimate was to the actual sales price, using Root Mean Square Error (RMSE). However, is RMSE a good proxy for fairness in this context?</p>
<p>Broad metrics of error like RMSE can be limiting when evaluating the “fairness” of a property appraisal system. RMSE does not tell us anything about the distribution of errors, whether the errors are positive or negative, and the relative size of the errors. It does not tell us anything about the regressivity of the model, instead just giving a rough measure of our model’s overall error.</p>
<p>Even with a low RMSE, we can’t guarantee a fair model. The error we see (no matter how small) may be a result of our model overvaluing less expensive homes and undervaluing more expensive homes.</p>
<p>Regarding accuracy, it’s important to ask what makes a batch of assessments better or more accurate than another batch of assessments. The value of a home that a model predicts is relational. It’s a product of the interaction of social and technical elements so property assessment involves social trust.</p>
<p>Why should any particular individual believe that the model is accurate for their property? Why should any individual trust the model?</p>
<p>To foster public trust, the CCAO focuses on “transparency”, putting data, models, and the pipeline onto GitLab. By doing so, they can better equate the production of “accurate assessments” with “fairness”.</p>
<p>Another aspect to consider when translating fairness into accuracy is how fairness and accuracy is experienced. The experience of being over-assessed and under-assessed is different depending on who you are. For example, a wealthy home-owner being over-assesed is more likely an inconvenience, as opposed to a lower income home-owner where being over-assessed might mean losing a home. Numbers alone can’t tell you that.</p>
<p>Simply trying to optimize for metrics of accuracy isn’t enough. We must also consider the real-life social impacts and harms from the perspectives of those who encounter them. In this sense a system that errs on the side of overvaluing high value homes and errs on the side of undervaluing lower value homes might be deemed as more fair, even if this means reducing the overall accuracy of the model.</p>
<p>There’s a lot more to be said here on the relationship between accuracy, fairness, and metrics we tend to use when evaluating our models. Given the nuanced nature of the argument, it is recommended you view the corresponding lecture as the course notes are not as comprehensive for this portion of the lecture.</p>
</section>
<section id="results-and-conclusions" class="level3">
<h3 class="anchored" data-anchor-id="results-and-conclusions">5. Results and Conclusions</h3>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Driving Questions
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>How successful is the system for each goal?
<ul>
<li>Accuracy/uniformity of the model</li>
<li>Fairness and transparency that eliminates regressivity and engenders trust</li>
</ul></li>
<li>How do you know?</li>
</ul>
</div>
</div>
<p>Unfortunately, it may be naive to hope that a more accurate and transparent algorithm will translate into more fair outcomes in practice. Even if our model is perfectly optimized according to the standards of fairness we’ve set, there is no guarantee that people will actually pay their expected share of taxes as determined by the model. While it is a good step in the right direction, maintaining a level of social trust is key to ensuring people pay their fair share.</p>
<p>Despite all their best efforts, the CCAO is still struggling to create fair assessments and engender trust.</p>
<p>Stories like <a href="https://www.axios.com/local/chicago/2022/12/01/why-chicagos-property-tax-bills-so-high">the one</a> show that total taxes for residential properties went up overall (because commercial taxes went down). But looking at the distribution, we can see that the biggest increases occurred in wealthy neighborhoods, and the biggest decreases occurred in poorer, predominantly Black neighborhoods. So maybe there was some success after all?</p>
<p>However, it’ll ultimately be hard to overcome the propensity of the board of review to reduce the tax burden of the rich, preventing the CCAO from creating a truly fair system. This is in part because there are many cases where the model makes big, frustrating mistakes. In some cases like <a href="https://www.axios.com/local/chicago/2023/05/22/cook-county-property-tax-appeal-process">this one</a>, it is due to spotty data.</p>
</section>
</section>
<section id="key-takeaways" class="level2">
<h2 class="anchored" data-anchor-id="key-takeaways">Key Takeaways</h2>
<p>So far, we’ve been asking the following questions:</p>
<ul>
<li>Under what conditions can data science solve a social problem?</li>
<li>Under what conditions can a detour through abstractions (numbers, data, models) bring about social change?</li>
</ul>
<p>In the specific case of Cook County housing, we ask the following questions:</p>
<ul>
<li>How does accuracy contribute to making a system more or less fair?</li>
<li>Under what conditions does accuracy become equivalent to fairness?</li>
</ul>
<p>Accuracy is not one, simple thing. Fairness is not one, simple thing.</p>
<p>When evaluating the accuracy and fairness of your model:</p>
<ul>
<li>Think about the model as part of a larger <strong>system</strong>.</li>
<li>Pay attention to the underlying distribution of social power.</li>
<li>Consider the concrete impacts the system has on different <strong>identities</strong>, and on people differently <strong>positioned</strong> in society.
<ul>
<li>The same mathematical error doesn’t have the same impact on everyone!</li>
</ul></li>
</ul>
<p>Accuracy isn’t “neutral”: Trying to make accuracy equivalent to fairness is always a <strong>political</strong> act.</p>
<ul>
<li>It involves commitment to a particular and contestable vision of a good social order. This means prioritizing some interests over others.</li>
</ul>
<p>Improving accuracy doesn’t necessarily bring about fairness.</p>
<ul>
<li>The numbers don’t “speak” for themselves.</li>
<li>Making accuracy equate to fairness is a rhetorical act that might fail to persuade (homeowners, voters, members of the review board) and engender social trust.</li>
</ul>
</section>
<section id="lessons-for-data-science-practice-questions-to-consider" class="level2">
<h2 class="anchored" data-anchor-id="lessons-for-data-science-practice-questions-to-consider">Lessons for Data Science Practice: Questions to Consider</h2>
<ol type="1">
<li><p>Question/Problem Formulation</p>
<ul>
<li>Who is responsible for framing the problem?</li>
<li>Who are the stakeholders? How are they involved in the problem framing?</li>
<li>What do you bring to the table? How does your positionality affect your understanding of the problem?</li>
<li>What are the narratives that you’re tapping into?</li>
</ul></li>
<li><p>Data Acquisition and Cleaning</p>
<ul>
<li>Where does the data come from?</li>
<li>Who collected it? For what purpose?</li>
<li>What kinds of collecting and recording systems and techniques were used?</li>
<li>How has this data been used in the past?</li>
<li>What restrictions are there on access to the data, and what enables you to have access?</li>
</ul></li>
<li><p>Exploratory Data Analysis &amp; Visualization</p>
<ul>
<li>What kind of personal or group identities have become salient in this data?</li>
<li>Which variables became salient, and what kinds of relationships do we see between them?</li>
<li>Do any of the relationships made visible lend themselves to arguments that might be potentially harmful to a particular community?</li>
</ul></li>
<li><p>Prediction and Inference</p>
<ul>
<li>What does the prediction or inference do in the world?</li>
<li>Are the results useful for the intended purposes?</li>
<li>Are there benchmarks to compare the results?</li>
<li>How are your predictions and inferences dependent upon the larger system in which your model works?</li>
</ul></li>
</ol>


</section>

</main> <!-- /main -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
    // 1. Select the specific parent div within the callout header that has the 
    //    collapse attributes (data-bs-toggle).
    var calloutToggles = document.querySelectorAll(
        '.callout-header[data-bs-toggle="collapse"]'
    );

    calloutToggles.forEach(function(toggle) {
        // 2. Force the ARIA role to be 'button'
        // This is crucial because a 'div' is not allowed to use aria-expanded.
        toggle.setAttribute('role', 'button');
        
        // 3. Ensure it is keyboard-focusable (critical accessibility fix)
        if (toggle.getAttribute('tabindex') === null) {
             toggle.setAttribute('tabindex', '0');
        }
    });

    // Scrollable Region Accessibility Fix:
    const selectors = '.cell-output-display, .cell-output, pre, code';
    
    const fixScrollability = () => {
        const regions = document.querySelectorAll(selectors);
        regions.forEach(el => {
            const hasHorizontalScroll = el.scrollWidth > el.clientWidth;
            const hasVerticalScroll = el.scrollHeight > el.clientHeight;

            if (hasHorizontalScroll || hasVerticalScroll) {
                if (!el.hasAttribute('tabindex')) {
                    el.setAttribute('tabindex', '0');
                    // Add a label so screen readers explain why this is focusable
                    el.setAttribute('aria-label', 'Scrollable content');
                }
            }
        });
    };

    // Run once on load
    fixScrollability();

    // Run again if the window is resized (which might trigger scrollbars)
    window.addEventListener('resize', fixScrollability);
});
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/ds100\.org\/course-notes\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>